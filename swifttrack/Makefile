# SwiftTrack Development Makefile
.PHONY: help setup install build dev test clean docker-up docker-down migrate seed smoke-test

# Default target
help:
	@echo "SwiftTrack Development Commands:"
	@echo "  setup      - Initialize development environment"
	@echo "  install    - Install all dependencies"
	@echo "  build      - Build all services"
	@echo "  dev        - Start all services in development mode"
	@echo "  test       - Run all tests"
	@echo "  clean      - Clean build artifacts"
	@echo "  docker-up  - Start infrastructure services"
	@echo "  docker-down- Stop infrastructure services"
	@echo "  migrate    - Run database migrations"
	@echo "  seed       - Seed database with test data"
	@echo "  smoke-test - Run end-to-end smoke tests"

# Setup development environment
setup:
	@echo "ğŸš€ Setting up SwiftTrack development environment..."
	node scripts/setup.js
	@echo "âœ… Setup completed!"

# Install dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	pnpm install
	@echo "âœ… Dependencies installed!"

# Build all services
build:
	@echo "ğŸ”¨ Building all services..."
	pnpm run build
	@echo "âœ… Build completed!"

# Start development servers
dev:
	@echo "ğŸš€ Starting development servers..."
	@$(MAKE) docker-up
	@sleep 10
	@$(MAKE) migrate
	@$(MAKE) seed
	pnpm run dev

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	pnpm run test
	@echo "âœ… Tests completed!"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	find . -name "dist" -type d -exec rm -rf {} + 2>/dev/null || true
	find . -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Clean completed!"

# Start infrastructure services
docker-up:
	@echo "ğŸ³ Starting infrastructure services..."
	docker compose up -d postgres redis rabbitmq minio prometheus grafana jaeger mock-cms mock-ros mock-wms
	@echo "â³ Waiting for services to be ready..."
	@sleep 15
	@echo "âœ… Infrastructure services started!"

# Stop infrastructure services
docker-down:
	@echo "ğŸ›‘ Stopping infrastructure services..."
	docker compose down
	@echo "âœ… Infrastructure services stopped!"

# Run database migrations
migrate:
	@echo "ğŸ—ƒï¸  Running database migrations..."
	cd packages/db && pnpm run migrate:up
	@echo "âœ… Migrations completed!"

# Seed database
seed:
	@echo "ğŸŒ± Seeding database..."
	cd packages/db && pnpm run seed
	@echo "âœ… Database seeded!"

# Run smoke tests
smoke-test:
	@echo "ğŸ§ª Running smoke tests..."
	node scripts/smoke-test.js
	@echo "âœ… Smoke tests completed!"

# Full development setup
dev-setup: setup install docker-up migrate seed
	@echo "ğŸ‰ Development environment ready!"
	@echo "ğŸš€ Run 'make dev' to start all services"

# Production build
prod-build:
	@echo "ğŸ­ Building for production..."
	NODE_ENV=production pnpm run build
	@echo "âœ… Production build completed!"

# Health check
health:
	@echo "ğŸ¥ Checking service health..."
	@curl -f http://localhost:3000/api/v1/health || echo "âŒ API Gateway not healthy"
	@curl -f http://localhost:3001/health || echo "âŒ Order Service not healthy"
	@curl -f http://localhost:5432 || echo "âŒ PostgreSQL not healthy"
	@curl -f http://localhost:6379 || echo "âŒ Redis not healthy"
	@curl -f http://localhost:15672 || echo "âŒ RabbitMQ not healthy"
	@echo "âœ… Health check completed!"

# Logs
logs:
	@echo "ğŸ“‹ Showing service logs..."
	docker compose logs -f

# Database reset
reset-db:
	@echo "âš ï¸  Resetting database..."
	@read -p "This will delete all data. Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker compose down postgres; \
		docker volume rm swifttrack_postgres_data || true; \
		$(MAKE) docker-up; \
		sleep 10; \
		$(MAKE) migrate; \
		$(MAKE) seed; \
		echo "âœ… Database reset completed!"; \
	else \
		echo "âŒ Database reset cancelled."; \
	fi
